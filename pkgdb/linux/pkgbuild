# package: linux

pkgname=linux
pkgver=pf-4.4
pkgdesc="Linux kernel fork which provides a handful of awesome features not merged into mainline"
url="https://pf.natalenko.name/"
source="https://github.com/pfactum/pf-kernel"

_builddir="$buildcache/$pkgname-$KERNELVERSION"
_buildflags=""

download() {
    if [ ! -d "$_builddir" ]; then
        git clone -b "$pkgver" --depth 1 "$source" "$_builddir"
    fi
}

prepare() {
    cd "$_builddir"

    mkdir -p /boot
    rm -rf /lib/modules/*

    cp -f "$pkgsrc/config.x86_64" .config
    cp -f "$pkgsrc/Makefile" Makefile

    echo "$KERNELVERSION" > include/config/kernel.release
}

build() {
    cd "$_builddir"

    make -j$threads silentoldconfig || return 1
    make -j$threads bzImage || return 1
    make -j$threads modules || return 1
}

package() {
    cd "$_builddir"
    if [ ! -f "$pkgcache/$pkgname-$pkgver.$pkgext" ]; then
        make -j1 install || return 1
        make -j1 modules_install || return 1
        tmpdir=$(mktemp -d)
        cd $tmpdir
        mkdir -p boot lib/modules
        mv /boot/vmlinuz boot
        #mv /lib/modules/
        (find bin | cpio -o -H newc | gzip -9) > "$pkgcache/$pkgname-$pkgver.$pkgext"
        rm -rf $tmpdir
    fi
}
