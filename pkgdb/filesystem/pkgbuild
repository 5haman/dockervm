# package: filesystem

pkgname=filesystem
pkgver=$version
pkgdesc="Base root filesystem layout for DockerVM"
url="https://github.com/5haman/dockervm"
source=""

download() {
    cp -Ra "$_srcdir/pkgsrc" "$_builddir"
}

prepare() {
    # install busybox
    apk --initdb --no-cache --root="$_builddir" --allow-untrusted add busybox-static
    chroot "$_builddir" /bin/busybox.static --install -s
    chroot "$_builddir" rm -f /bin/busybox.static
}

build() {
    # setup os-release
    sed -i "s#{{VERSION}}#${version}#g" "$_builddir/etc/os-release"

    # add users and symlinks
    chroot "$_builddir" sh -c \
        "passwd root -d 'toor';
        addgroup -S docker;
        addgroup -S dnsmasq;
        adduser -S -D -H -h /dev/null -s /sbin/nologin -G  docker docker;
        adduser -S -D -H -h /dev/null -s /sbin/nologin -G  dnsmasq dnsmasq;
        ln -s /etc/s6 /etc/s6-rc;
        rm -rf /var/run;
        ln -s /run /var/run"

    install -m0664 -o root -g utmp /dev/null "$_builddir/run/utmp"
    install -m0664 -o root -g utmp /dev/null "$_builddir/var/log/wtmp"
    install -m0600 -o root -g utmp /dev/null "$_builddir/var/log/lastlog"
}

package() {
    cd "$_builddir"
    find | cpio -o -H newc | gzip -9 > "$pkgcache/$pkgname-$pkgver.$pkgext"
}
