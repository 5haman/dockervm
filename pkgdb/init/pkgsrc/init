#!/bin/execlineb -S0
#
# Early init stage
# Init modules and set system params
# then switch root and run stage1

/bin/cd /
/bin/export PATH "/usr/local/bin:/usr/bin:/usr/sbin:/bin:/sbin"

umask 022

# load modules
foreground {
    if { s6-test -e /etc/modules }
    redirfd -r 0 /etc/modules
    pipeline { s6-grep -vF -- "#" }
    forstdin -nCd"\n" -- mod
    importas -ui -D "" mod mod
    modprobe -q $mod
}

# mount filesystems
foreground {
    if { mount /proc }
    if { mount /sys }
    if { mount /dev }
    if { mount /run }
    if { mount /tmp }
    if { mkdir -p /mnt/bootdisk }
    if { mount /mnt/bootdisk }
    if { mkdir -p /mnt/lower1 }
    if { mount /mnt/lower1 }
}

if { /etc/s6/init/zoverlay }
exec -c
/bin/busybox switch_root /newroot /etc/s6/init/stage1
