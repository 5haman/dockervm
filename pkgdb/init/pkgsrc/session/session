#!/bin/bash

function restore_session() {
    CLIENTID="$1_`whoami`_`date +%S`"
    /usr/bin/s6-withenv tmux new-session -d -t $1 -s $CLIENTID \; set-option destroy-unattached \; attach-session -t $CLIENTID
}

function new_session() {
    /usr/bin/s6-withenv tmuxifier load-session $1
    restore_session $1
}

eval "$(tmuxifier init -)"

tmux_nb=$(tmux ls 2>&1 | grep "^$USER" | wc -l)

if [[ "$tmux_nb" == "0" ]]; then
    new_session login
else
    # Make sure we are not already in a tmux session
    if [[ -z "$TMUX" ]]; then
	restore_session login
    else
        /usr/bin/s6-withenv /bin/bash -i
    fi
fi

clear
exit 0
