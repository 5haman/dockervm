#!/usr/bin/env bash

_VERSION=0.1

set -e
[ -n "$DEBUG" ] && set -x

threads=$(cat /proc/cpuinfo | grep processor | wc -l)
pkgext=pkg
srcdir="/tmp/build"
workdir="$SRC_DIR/pkg"
pkgdir="$SRC_DIR/.cache"
destdir="/"

mkdir -p "$pkgdir" "$srcdir"

build_spk() {
    source "$workdir/$1/pkgbuild"
    if [ ! -f "$pkgdir/$pkgname-$pkgver.$pkgext" ]; then
        log " => Building '$pkgname-$pkgver.$pkgext'"
        rm -rf "$srcdir/$pkgname-$pkgver"
        download
        prepare
        build
        package
    else
        log " => '$pkgname-$pkgver.$pkgext' already exists, skipping"
    fi
}

build_all() {
    for spk in "$@"; do
        build_spk $spk
    done
}

install_spk() {
    source "$workdir/$1/pkgbuild"
    if [ ! -f "$pkgdir/$pkgname-$pkgver.$pkgext" ]; then
        log " => '$pkgname-$pkgver.$pkgext' not found, trying to build now"
        build_spk $1
    fi

    log " => Installing '$pkgname-$pkgver.$pkgext'"
    gunzip -cf "$pkgdir/$pkgname-$pkgver.$pkgext" | cpio -i -d -f -D "$destdir"
}

install_all() {
    for spk in "$@"; do
        install_spk $spk
    done
}

log() {
    echo $'\e['"1;31m$(date "+%Y-%m-%d %H:%M:%S") [$(basename $0)] ${@}"$'\e[0m'
}

usage() {
    printf "Usage: $(basename "$0") [-d|-h|-v] command [<package> ...]

Options:
  --dir,     -d <dir>   Destination directory for installation
  --help,    -h         Display CLI help (this message)
  --version, -v         Print the version and exit

Commands:
  build,   b            Build static package(s)
  install, i            Install static package(s)
"
}

set_dest() {
    if [ -d "$1" ]; then
         destdir=$1
    else
         log "$1: can't find destination directory, exiting!"
         exit 1
    fi
}

case "$1" in
    --dir|-d)        set_dest $2; shift; shift;;
    *)               ;;
esac

case "$1" in
    --help|-h)       usage;;
    --version|-v)    echo "$(basename $0): $_VERSION";;
    install|i*)      shift; install_all "$@";;
    build|b*)        shift; build_all "$@";;
    *)               usage; exit 1;;
esac
