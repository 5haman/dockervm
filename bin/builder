#!/usr/bin/env bash

set -e
[ "$debug" == "true" ] && set -x

buildroot=${buildroot:-/var/cache/pkg}
buildcache=${buildcache:-$HOME/.cache/dockervm}
rootfs="$buildcache/rootfs"
isodir="$buildcache/iso"

mkdir -p "$rootfs" "$isodir"
rm -rf "$rootfs/*" "$isodir/*"

# install libraries to builder container which required for static builds
pkgman install \
	libevent libmnl libnftnl readline e2fsprogs \
	libressl ncurses skalibs execline s6 zlib
            
# install main packages for stage1
pkgman -d $rootfs install \
	filesystem bash curl dhcpcd dropbear execline htop iptables linux \
        s6 s6-linux-utils s6-portable-utils s6-rc tmux tmuxifier

# install bootloader
pkgman -d $isodir install syslinux

# create main sqashfs image
#mksquashfs $rootfs $isodir/rootfs.img -b 1048576 -comp xz -Xdict-size 100%

# Builds an image that can be used as an ISO and a disk image
xorriso -as mkisofs \
        -publisher "DockerVM" \
        -c syslinux/boot.cat \
        -b syslinux/isolinux.bin \
        -no-emul-boot -boot-load-size 4 -boot-info-table \
        -isohybrid-mbr syslinux/isohdpfx.bin \
        -eltorito-alt-boot \
        -e /ramdisk.img \
        -no-emul-boot -isohybrid-gpt-basdat \
        -o "$buildroot/dist/dockervm.iso" $isodir
