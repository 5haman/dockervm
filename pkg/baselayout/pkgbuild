# package: baselayout

pkgname=baselayout
pkgver=0.1
pkgdesc="Base root filesystem layout for DockerVM"
url="https://github.com/5haman/dockervm"
source="pkgsrc"

_builddir="$srcdir/$pkgname-$pkgver"
_buildflags=""

download() {
    cd "$srcdir"
    cp -Ra "$workdir/$pkgname/$source" "$_builddir"
}

prepare() {
    cd "$_builddir"

    # install alpine base
    apk-install --initdb --root="$_builddir" --allow-untrusted \
        alpine-baselayout \
        busybox-static \
        busybox-initscripts

    # setup os-release
    sed -i "s#{{VERSION}}#${VERSION}#g" "$_builddir/etc/os-release"

    chroot "$_builddir" /bin/busybox.static --install -s
    chroot "$_builddir" ln -s /bin/busybox.static /bin/busybox

    # install kernel modules
    moddir="/lib/modules/$(ls /lib/modules)"
    cd "$moddir"
    cat "$workdir/$pkgname/base.modules" | cpio -d -u -m -p "$_builddir/$moddir"
}

build() {
    cd "$_builddir"
}

package() {
    cd "$_builddir"
    if [ ! -f "$pkgdir/$pkgname-$pkgver.$pkgext" ]; then
        # strip binary files
        sh -c "find -type f | xargs strip --strip-all &>/dev/null; exit 0"

        find | cpio -o -H newc | gzip -9 > "$pkgdir/$pkgname-$pkgver.$pkgext"
    fi
}
